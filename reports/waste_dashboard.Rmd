---
title: "Waste Board"
output: 
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      bootswatch: lux
    orientation: columns
    vertical_layout: fill
---

<style>
.navbar {
  margin: 0;
  padding: 0;
  height: 5.5%;
  display: block;
  position: fixed;

}
</style>



General stats
===



```{r setup, include=FALSE}
# Packages
library(tidyverse)
library(flexdashboard)
library(leaflet)
library(rnaturalearth)
library(sp)
library(bslib)

# Parameters
  #input
file_raw <- here::here("data/clean_waste_base_data.rds")

# theme update

theme_set(theme_classic())

# read data 
df <- read_rds(file_raw)

# set uniform themec("#43CD80", "#FFFFFF", "#FFFFFF")

# thematic::thematic_rmd(bg = 'white', fg = 'seagreen3', accent = 'black')
thematic::thematic_on()

```

Column 
-----------------------------------------------------------------------

### {data-height=450}

#### Context
Regularly-collected data about single-use plastic bottle waste found in public spaces, identified to the level of individual commercial products.

#### Content
This data was collected from March 2021 to April 2022 using the Wastebase digital platform for crowd-sourced data collection about single-use plastic waste.

Data is collected via an app for Android or iPhone, and then checked and linked to Brand and Product information by Wastebase Data Partners. Data is collected to the level of the specific product barcode, timestamped and location stamped. You can search for specific data on the [Wastebase data page](https://wastebase.org/#/data).



### Top 5 brands scanned in each country 


```{r, fig.width=9,fig.height=7}



df |> 
    group_by(brand_name, scan_country) |> 
    summarise(total = sum(bottle_count)) |> 
    group_by(scan_country) |> mutate(scan_country=fct_reorder(scan_country, total, .desc = TRUE))|> 
    slice_max(order_by = total,n = 5) |> 
    arrange(total) -> countries_arranged

## Recoding countries_arranged$scan_country into countries_arranged$scan_country_rec
countries_arranged$scan_country_rec <- countries_arranged$scan_country %>%
  fct_recode(
    "Angola" = "ao",
    "Brazil" = "br",
    "Canada" = "ca",
    "Switzerland" = "ch",
    "Spain" = "es",
    "France" = "fr",
    "Great Britain" = "gb",
    "Kenya" = "ke",
    "Malawi" = "mw",
    "Mozambique" = "mz",
    "Netherlands" = "nl",
    "Rwanda" = "rw",
    "Tanzania" = "tz",
    "Uganda" = "ug",
    "South Africa" = "za",
    "Zambia" = "zm"
  )

    # fct_reorder(df$brand_name,total, min, .desc = TRUE)
    # na.omit() |> 
   ggplot(countries_arranged,aes(total, fct_inorder(droplevels(brand_name)))) +
    geom_col(fill = "aquamarine4") +
    facet_wrap( ~ fct_rev(fct_inorder(scan_country_rec)), scales = "free") +
      labs(x = "", y = "") +
  coord_cartesian(expand = F,
                  clip = "off") +
    theme(
    strip.background = element_blank(),
    strip.placement = "outside",
    strip.text = element_text(colour = "black",
                              hjust = 0,
                              face = "bold",
                              size = 10),
    axis.text.y = element_text(size =10,
                               face = "bold",
                               color = "black"),
    axis.text.x = element_text(size =8,
                               face = "bold",
                               angle = 45,
                               vjust = 0.5)
    )
   

```

Column {.tabset data-width=1000}
-----------------------------------------------------------------------


### Total bottles collected per country

```{r}

map <- ne_countries()


scan_country_count <- df |> 
  group_by(scan_country) |> 
  summarise(total_bottles = sum(bottle_count))

map$bottle_count <- as_vector(scan_country_count[match(map$iso_a2,str_to_upper(scan_country_count$scan_country)), "total_bottles"])

# set color palettte for map

pal <- colorBin(
  palette = "Greens", domain = map$bottle_count,
  bins = seq(0, max(map$bottle_count, na.rm = TRUE) + 10, by = 10)
)


map$labels <- paste0(
  "<strong> Country: </strong> ",
  map$name, "<br/> ",
  "<strong> Bottle Count: </strong> ",
  map$bottle_count, "<br/> "
) %>%
  lapply(htmltools::HTML)

leaflet(map) |> 
  addTiles() |> 
  setView(lng = 25, lat = 0, zoom = 4) %>%
  addPolygons(
    fillColor = ~ pal(bottle_count),
    color = "white",
    fillOpacity = 0.7,
    label = ~labels,
    highlight = highlightOptions(
      color = "black",
      bringToFront = TRUE
    )
  ) 
 

```


### Scan country distribution

```{r}
df |> 
  group_by(scan_country) |> 
  summarise(total = sum(bottle_count)) |> 
  arrange(total) |> 
  ggplot(aes(total, fct_inorder(scan_country))) + 
  geom_col(fill = "aquamarine4") +
  geom_label(aes(label = total)) +
      labs(x = "", y = "") +
  coord_cartesian(expand = F,
                  clip = "off")
```


### Manufacturer country distribution

```{r}
df |> 
  group_by(manufacturer_country) |> 
  summarise(total = sum(bottle_count)) |> 
  arrange(total) |> 
  ggplot(aes(total, fct_inorder(manufacturer_country))) + 
  geom_col(fill = "aquamarine4") +
  geom_label(aes(label = total)) +
      labs(x = "", y = "") +
  coord_cartesian(expand = F,
                  clip = "off")
```




Column {data-width=650}
-----------------------------------------------------------------------



### **Batch amount progression**


```{r, fig.width=11, fig.height=6}
df |> 
  group_by(batch) |> 
  summarise(total_bottles = sum(bottle_count)) |> 
  ggplot(aes(batch,total_bottles)) +
  geom_col(fill = "aquamarine4") +
  geom_line(aes(group = 1)) +
  geom_point()  +
      labs(x = "", y = "") +
  coord_cartesian(expand = T,
                  clip = "off") +
  scale_y_continuous(labels = scales::comma,
                     breaks = seq(0,200000, 10000))+
  geom_label(aes(label = total_bottles),
             nudge_y = 5000,
             label.size = 1,
             size = 7) + 
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(face = "bold",
                               size = 13,
                               vjust = 0.5),
    axis.ticks = element_blank(),
    axis.line = element_blank()
  )
  # geom_label(aes(label = total_bottles))


```



### **Product category distribution**

```{r, fig.width=13}
df |> 
  group_by(product_category) |> 
  summarise(total = sum(bottle_count)) |> 
  arrange(total) |> 
  ggplot(aes(total,fct_inorder(product_category))) +
  geom_col(fill = "aquamarine4") +
      labs(x = "", y = "") +
  geom_label(aes(label = total),
             hjust = 0.5,
             size = 7,
             label.size = 1)+
  coord_cartesian(expand = T,
                  clip = "off") +
 
  scale_x_continuous(position = "top",
                     labels = scales::comma) +
  theme(
    axis.text.y = element_text(size =22,
                               lineheight = 4,
                               hjust = 0.5,
                               color = "black"),
    axis.text.x = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    axis.title = element_blank()
  )

```

### **Plastic bottle capacities (in ml)**

```{r, fig.width=10, echo=FALSE, fig.cap="ETL project, Author: Peter Boshe https://peterboshe.netlify.app/", out.width = '100%'}
df |> 
  filter(units == "ml") |>
  mutate(amount = round(amount),
         amount_category = fct_inorder(case_when(
           amount < 500 ~ "less than 500",
           amount >= 500 & amount < 1000 ~ "500-1000",
           amount >= 1000 & amount < 2000 ~ "1000-2000",
           amount >= 2000 & amount < 5000 ~ "2000-5000",
           TRUE ~ "greater than 5000"
           ))
  ) |> 
  mutate(amount_category = fct_relevel(amount_category, "greater than 5000", after = 4)) |> # HACK releveling default levels
  count(amount_category) |> 
  ggplot(aes(n, fct_rev(amount_category))) + # HACK flipping your levels with forcats
  geom_col(fill = "aquamarine4") +
  geom_label(aes(label = n),
             size = 7,
             label.size = 1) +
      labs(x = "", y = "") +
  theme(
    axis.text.y = element_text(size =22,
                               hjust = 0.5,
                               lineheight = 4,
                               color = "black"),
    axis.text.x = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank()
  ) +
  scale_x_continuous(position = "top",
                     breaks = seq(0,5000,1000))+
  coord_cartesian(expand = T,
                  clip = "off")
```


Individual Country Reports
===

#### Coming soon!

Predictive Analysis
===

#### Coming soon!


