---
title: "Waste dataviz 1"
author: "Peter Boshe"
date: "01/06/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = 'center', collapse = TRUE, echo = FALSE, message = FALSE)
```



```{r}
# Packages
library(tidyverse)
# library(gghighlight)
library(ggtext)
library(patchwork)
library(showtext)

# Parameters
  #input
file_raw <- here::here("data/clean_waste_base_data.rds")

# theme update

theme_set(theme_classic())

# colors

water_color <- "#016fb9"
soft_color <- "#ff9505"
energy_color <- "#ec4e20"

# import fonts

font_add_google('Lora', 'lora')
font_add_google('Fira Sans', 'firasans')
font_add_google('Dosis', 'dosis')
showtext_auto()

```



```{r}
df <- read_rds(file_raw)

## Recoding df$product_category into df$product_category_rec
df$product_category_rec <- df$product_category %>%
  fct_recode(
    "juices and punches" = "juice",
    "energy drinks" = "energy drink",
    "carbonated drinks" = "carbonated drink"
  )

## Recoding df$month into df$month_rec
df$month_rec <- df$month %>%
  fct_recode(
    "Jan" = "01",
    "Feb" = "02",
    "Mar" = "03",
    "Apr" = "04",
    "May" = "05",
    "Jun" = "06",
    "Jul" = "07",
    "Aug" = "08",
    "Sep" = "09",
    "Oct" = "10",
    "Nov" = "11",
    "Dec" = "12"
  )

df |> 
  group_by(year, month_rec, product_category_rec) |> 
  summarise(total_bottles = sum(bottle_count)) |> ## Reordering df$product_category
  mutate(
    product_category_rec = fct_reorder(product_category_rec, total_bottles, .desc = T),
    color_dat = fct_inorder(case_when(
    product_category_rec == "water" ~ water_color,
    product_category_rec == "carbonated drinks" ~ soft_color,
    product_category_rec == "energy drinks" ~ energy_color,
    TRUE ~ "darkgrey"
  ))) -> colored_data

## Reordering colored_data$product_category_rec
colored_data$product_category_rec <- colored_data$product_category_rec %>%
  fct_relevel(
    "domestic products", "food products", "unknown", "juices and punches",
    "hard liquor", "beer", "energy drinks", "carbonated drinks",
    "water"
  )



glimpse(colored_data)

  ggplot(colored_data, aes(month_rec,total_bottles, group = product_category_rec)) +
  geom_col(fill = colored_data$color_dat,
           color = "white") +
  facet_wrap( ~ year) +
  labs(title = "Can we not handle our petty bottles better?",
       # subtitle = "Water and Carbonated Soft drinks products contributing to more than 50% of total waste collected",
       caption = "Source:wastebase.io",
       y = "TOTAL UNITS COLLECTED",
       x = "") -> p
```



```{r}
# HACK annotating individual facets

label_text <- data.frame(year = c(2022, 2021, 2022), 
                         label = c("The total waste collected <br>has been rising steadily<br> since start of project<br>","<span style='color:#016fb9'> **Water**</span> and <span style='color:#ff9505'>**Carbonated Soft drinks** </span> <br>products contributing to more than <br>**50%** of total waste collected","Although we also had <br>other product categories <br>like hard liquor,<br> juices&punches,<br>domestic products and <br>food products, These <br>were not as <br>abundant as their <br>counterparts<br>highlighted"),
                         month_rec = c(9,7,9),
                         total_bottles = c(170000,130000,60000),
                         product_category_rec = c("","","")) # HACK this line was needed to silence error


title_text <- "Can we **not** handle our petty drinks better?"
caption_text <- "Source:wastebase.io"


p + theme(
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white"),
    # panel.background = element_blank(),
    axis.text = element_text(colour = "darkgrey",
                            size = 10),
    axis.line.y = element_blank(),
    axis.line.x = element_line(colour = "darkgrey"),
    axis.ticks.x = element_line(colour = "darkgrey"),
    axis.ticks.y = element_blank(),
    strip.background = element_blank(),
    strip.placement = "outside",
    strip.text = element_text(colour = "darkgrey",
                              hjust = 0,
                              face = "bold"),
    axis.title.y = element_text(colour = "darkgrey",
                                hjust = 1),
    plot.title.position = "plot",
    title = element_blank()
  ) +
  scale_x_discrete(position = "top") +
  scale_y_continuous(breaks = seq(0,200000,10000),
                    limits = c(0,200000),
                    labels = scales::comma) +
  geom_richtext(data = label_text,
            aes(x = month_rec, y = total_bottles, 
                label = label),
            label.color = NA,
            fill = NA,
            size = 6,
            family = 'dosis') +
  coord_cartesian(expand = F,
                  clip = "off") +
  plot_annotation(
    title = title_text,
    caption = caption_text,
    theme = theme(
      plot.title = element_markdown(
        # margin = margin(b = 0.4, unit = 'cm'),
        # 0.4cm margin at bottom of title
        size = 16,
        colour = "#016fb9",
        linewidth = 6
      ),
      plot.caption.position = 'plot',
      plot.caption = element_markdown(
        hjust = 0, 
        size = 9, 
        colour = "darkgrey", 
        lineheight = 1.25
      ),
      plot.background = element_rect(fill = 'white', colour = NA)
      # This is only a trick to make sure that background really is white
      # Otherwise, some browsers or photo apps will apply a dark mode
    )
  )
  


```

